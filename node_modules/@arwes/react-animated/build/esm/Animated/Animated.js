import { createElement, useRef, useMemo } from 'react';
import { memo, mergeRefs } from '@arwes/react-tools';
import { useAnimator } from '@arwes/react-animator';
import { formatAnimatedCSSProps } from '@arwes/animated';
import { useAnimated } from '../useAnimated/index.js';
const AnimatedComponent = (props) => {
    const { as: asProvided, animated, className, style, elementRef: externalElementRef, hideOnExited = true, hideOnEntered, onTransition, ...otherProps } = props;
    const animator = useAnimator();
    const as = useMemo(() => asProvided || 'div', []);
    const elementRef = useRef(null);
    useAnimated(elementRef, animated, {
        renderInitials: false,
        hideOnExited,
        hideOnEntered,
        onTransition
    });
    const animatedSettingsListReceived = Array.isArray(animated) ? animated : [animated];
    const animatedSettingsList = animatedSettingsListReceived
        .map((item) => (typeof item === 'string' || Array.isArray(item) ? undefined : item))
        .filter(Boolean);
    let initialAttributes;
    if (animator) {
        initialAttributes = animatedSettingsList
            .map((item) => (item ? item.initialAttributes : undefined))
            .reduce((total, item) => ({ ...total, ...item }), {});
    }
    let dynamicStyles;
    if (animator) {
        dynamicStyles = animatedSettingsList
            .map((item) => (item ? item.initialStyle : undefined))
            .filter(Boolean)
            .map((styles) => formatAnimatedCSSProps(styles))
            .reduce((total, item) => ({ ...total, ...item }), {});
    }
    return createElement(as, {
        ...otherProps,
        ...initialAttributes,
        ref: mergeRefs(externalElementRef, elementRef),
        className,
        style: {
            ...style,
            visibility: animator &&
                ((hideOnExited && animator.node.state === 'exited') ||
                    (hideOnEntered && animator.node.state === 'entered'))
                ? 'hidden'
                : '',
            ...dynamicStyles
        }
    });
};
export const Animated = memo(AnimatedComponent);
